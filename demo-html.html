<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WP2 Update :: Interactive Demo</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* General Styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .wp2-wrap {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 2rem;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .wp2-wrap.loaded {
            opacity: 1;
        }
        .wp2-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 1.5rem;
        }
        .wp2-main-title {
            font-weight: 700;
            color: #212529;
        }

        /* Tabs */
        .nav-tabs .nav-link {
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            background-color: #f8f9fa;
            border-color: #dee2e6 #dee2e6 #f8f9fa;
        }

        /* Cards */
        .card {
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid #e9ecef;
        }
        .stat-card .card-title {
            font-size: 1rem;
            font-weight: 600;
            opacity: 0.8;
        }
        .stat-card .card-text {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .stat-card a {
            text-decoration: none;
        }
        .stat-card a:hover {
            text-decoration: underline;
        }

        /* Log Viewer */
        .log-viewer {
            background-color: #212529;
            color: #ced4da;
            padding: 1rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
            height: 250px;
            overflow-y: scroll;
        }
        .log-entry.error { color: #f97171; }
        .log-entry.warning { color: #ffca2c; }
        .log-entry.info { color: #56b6c2; }

        /* General UI Elements */
        .table-hover tbody tr:hover {
            background-color: #f1f3f5;
        }
        .badge {
            font-weight: 600;
        }
        .toast-container {
            z-index: 1090;
        }
        .form-label {
            font-weight: 600;
        }
        .btn .spinner-border {
            width: 1rem;
            height: 1rem;
            border-width: .2em;
        }
    </style>
</head>
<body>
    <!-- Root component for the Lit application -->
    <div id="app-container">
        <wp2-update-app></wp2-update-app>
    </div>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "lit": "https://cdn.jsdelivr.net/gh/lit/dist@3/core/lit-core.min.js",
            "lit/decorators.js": "https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js",
            "nanostores": "https://cdn.jsdelivr.net/npm/nanostores@0.9.5/index.js",
            "@nanostores/lit": "https://cdn.jsdelivr.net/npm/@nanostores/lit@0.5.0/index.js"
        }
    }
    </script>

    <!-- Main Application Logic -->
    <script type="module">
        import { LitElement, html } from 'lit';
        import { customElement, property } from 'lit/decorators.js';
        import { atom } from 'nanostores';
        import { StoreController } from '@nanostores/lit';

        // =================================================================
        // 1. STATE MANAGEMENT (with Nanostores)
        // =================================================================
        const store = atom({
            activeTab: 'dashboard',
            packages: [],
            apps: [],
            health: {},
            logs: [],
            stats: { updates: 0, unmanaged: 0, total: 0, apps: 0 },
            activeModal: null,
            modalProps: {},
            notifications: [],
        });

        // --- Helper functions for state updates ---
        function updateState(newState) {
            store.set({ ...store.get(), ...newState });
        }
        
        function recalculateStats() {
            const { packages, apps } = store.get();
            updateState({
                stats: {
                    updates: packages.filter(p => p.status === 'update').length,
                    unmanaged: packages.filter(p => p.status === 'unmanaged').length,
                    total: packages.length,
                    apps: apps.length,
                }
            });
        }

        let notificationId = 0;
        function addNotification(type, message, duration = 4000) {
            const note = { id: notificationId++, type, message };
            const currentNotifications = store.get().notifications;
            updateState({ notifications: [...currentNotifications, note] });

            setTimeout(() => {
                const current = store.get().notifications;
                updateState({ notifications: current.filter(n => n.id !== note.id) });
            }, duration);
        }

        function setPackageProcessingState(repo, stateKey, isProcessing) {
            const currentPackages = store.get().packages;
            const updatedPackages = currentPackages.map(p => 
                p.repo === repo ? { ...p, [stateKey]: isProcessing } : p
            );
            updateState({ packages: updatedPackages });
        }


        // =================================================================
        // 2. SIMULATED ACTIONS
        // =================================================================
        const simulateApiCall = (duration = 1000) => new Promise(res => setTimeout(res, duration));
        
        // --- Mock Data ---
        const MOCK_PACKAGES = [
            { name: 'Agency Core Plugin', repo: 'agency/core-plugin', version: '1.5.2', latest: '1.6.0', status: 'update', releases: ['1.5.1', '1.5.0', '1.4.8'] },
            { name: 'Client Project Theme', repo: 'client/project-theme', version: '2.1.0', latest: '2.1.0', status: 'ok', releases: ['2.0.0', '1.9.5'] },
            { name: 'Unlinked Utility Plugin', repo: 'agency/utility-plugin', version: '1.0.0', latest: '-', status: 'unmanaged', releases: [] },
            { name: 'Internal Framework', repo: 'agency/internal-framework', version: '3.0.1', latest: '3.0.1', status: 'ok', releases: ['3.0.0'] },
        ];

        const MOCK_APPS = [
            { id: 1, name: 'WP-Internal-Tools', account: 'AgencyInc (Organization)', packages: 8, status: 'failed' },
            { id: 2, name: 'Client-Projects-Access', account: 'johndoe (User)', packages: 4, status: 'connected' }
        ];

        const MOCK_HEALTH = {
            environment: [
                { check: 'PHP Version', message: '8.2.11 meets requirement of 8.0+.', status: 'success' },
                { check: 'WordPress Version', message: '6.4.1 meets requirement of 6.0+.', status: 'success' },
            ],
            integrity: [
                { check: 'Database Schema', message: 'Required tables are correctly installed.', status: 'success' },
                { check: 'REST API', message: 'Plugin endpoints are registered.', status: 'success' },
            ],
            connectivity: [
                { check: 'GitHub App: WP-Internal-Tools', message: 'Could not connect to GitHub. The token may be invalid or expired.', status: 'danger' },
                { check: 'GitHub App: Client-Projects-Access', message: 'Connection to GitHub succeeded.', status: 'success' },
            ]
        };

        const MOCK_LOGS = [
            { level: 'info', message: '[2025-10-15 17:45:10] Package sync initiated via REST API.' },
            { level: 'info', message: '[2025-10-15 17:42:05] Package update successful. repo_slug: agency/site-plugin' },
            { level: 'error', message: '[2025-10-15 17:41:50] Package update failed. repo_slug: client/project-theme, exception: Download failed: Not Found' },
            { level: 'info', message: '[2025-10-15 17:40:00] Incoming webhook received. event: release' },
            { level: 'warning', message: '[2025-10-15 17:35:12] Permission denied: Invalid nonce. action: wp2_assign_package, user_id: 1' },
        ];


        async function fetchInitialData() {
            await simulateApiCall(800);
            updateState({ 
                packages: MOCK_PACKAGES,
                apps: MOCK_APPS,
                health: MOCK_HEALTH,
                logs: MOCK_LOGS,
            });
            recalculateStats();
            document.querySelector('.wp2-wrap').classList.add('loaded');
        }

        async function syncAllPackages() {
            addNotification('info', 'Syncing all packages...');
            await simulateApiCall(2000);
            addNotification('success', `Sync complete. ${store.get().packages.length} packages found.`);
        }
        
        async function updatePackage(pkg) {
            setPackageProcessingState(pkg.repo, 'isUpdating', true);
            await simulateApiCall(1500);
            const currentPackages = store.get().packages;
            const updatedPackages = currentPackages.map(p =>
                p.repo === pkg.repo ? { ...p, version: p.latest, status: 'ok' } : p
            );
            updateState({ packages: updatedPackages });
            recalculateStats();
            addNotification('success', `${pkg.name} updated to version ${pkg.latest}.`);
            setPackageProcessingState(pkg.repo, 'isUpdating', false);
        }
        
        async function rollbackPackage(pkg, version) {
            updateState({ activeModal: null });
            addNotification('info', `Rolling back ${pkg.name} to ${version}...`);
            await simulateApiCall(1500);
            const currentPackages = store.get().packages;
            const updatedPackages = currentPackages.map(p =>
                p.repo === pkg.repo ? { ...p, version, status: p.version === p.latest ? 'ok' : 'update' } : p
            );
            updateState({ packages: updatedPackages });
            recalculateStats();
            addNotification('success', `${pkg.name} rolled back to version ${version}.`);
        }

        async function assignAppToPackage(pkg, appId) {
            updateState({ activeModal: null });
            addNotification('info', `Assigning app to ${pkg.name}...`);
            await simulateApiCall(1200);
            const currentPackages = store.get().packages;
            const updatedPackages = currentPackages.map(p =>
                p.repo === pkg.repo ? { ...p, status: 'ok' } : p
            );
            updateState({ packages: updatedPackages });
            recalculateStats();
            addNotification('success', `App assigned to ${pkg.name}.`);
        }
        
        async function deleteApp(appToDelete) {
             if (!confirm(`Are you sure you want to delete the app "${appToDelete.name}"?`)) return;
             addNotification('info', `Deleting ${appToDelete.name}...`);
             await simulateApiCall(1000);
             const currentApps = store.get().apps;
             updateState({ apps: currentApps.filter(a => a.id !== appToDelete.id) });
             recalculateStats();
             addNotification('success', `${appToDelete.name} has been deleted.`);
        }

        async function createPackage(newPackageData) {
            updateState({ activeModal: null });
            addNotification('info', `Creating repository for ${newPackageData.repoName}...`);
            await simulateApiCall(2000);
            const newPackage = {
                name: newPackageData.repoName.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),
                repo: `${newPackageData.assignApp}/${newPackageData.repoName}`,
                version: '1.0.0',
                latest: '1.0.0',
                status: 'ok',
                releases: []
            };
            const currentPackages = store.get().packages;
            updateState({ packages: [newPackage, ...currentPackages] });
            recalculateStats();
            addNotification('success', `Package ${newPackage.name} created successfully.`);
        }


        // =================================================================
        // 3. LIT COMPONENTS & VIEWS
        // =================================================================
        
        // --- Main Application Shell ---
        @customElement('wp2-update-app')
        class Wp2UpdateApp extends LitElement {
            store = new StoreController(this, store);

            render() {
                const { activeTab } = this.store.value;

                return html`
                    <div class="wp2-wrap">
                        <!-- Header -->
                        <header class="wp2-header d-flex flex-column flex-md-row align-items-md-center justify-content-md-between mb-4">
                            <div>
                                <h1 class="wp2-main-title">WP2 Update</h1>
                                <p class="text-muted">Manage your GitHub-hosted plugins and themes with clarity, confidence, and control.</p>
                            </div>
                            <div class="d-flex gap-2 mt-3 mt-md-0">
                                <button class="btn btn-success" @click=${() => updateState({ activeModal: 'createPackage' })}>
                                    <i class="bi bi-plus-lg me-1"></i> Create Package
                                </button>
                                <button class="btn btn-primary" @click=${() => updateState({ activeModal: 'addApp' })}>
                                    <i class="bi bi-github me-1"></i> Add GitHub App
                                </button>
                                <button id="sync-all-btn" class="btn btn-outline-secondary" @click=${syncAllPackages}>
                                    <i class="bi bi-arrow-repeat me-1"></i> Sync All
                                </button>
                            </div>
                        </header>

                        <!-- Tabs Navigation -->
                        <ul class="nav nav-tabs" id="mainTab" role="tablist">
                            ${['dashboard', 'packages', 'apps', 'health'].map(tab => html`
                                <li class="nav-item" role="presentation">
                                    <a class="nav-link ${activeTab === tab ? 'active' : ''}" @click=${() => updateState({ activeTab: tab })}>${tab.charAt(0).toUpperCase() + tab.slice(1)}</a>
                                </li>
                            `)}
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content pt-4">
                            ${activeTab === 'dashboard' ? html`<dashboard-view></dashboard-view>` : ''}
                            ${activeTab === 'packages' ? html`<packages-view></packages-view>` : ''}
                            ${activeTab === 'apps' ? html`<apps-view></apps-view>` : ''}
                            ${activeTab === 'health' ? html`<health-view></health-view>` : ''}
                        </div>
                    </div>
                    <modal-manager></modal-manager>
                    <notification-center></notification-center>
                `;
            }

            createRenderRoot() { return this; }
        }

        // --- Views ---
        @customElement('dashboard-view')
        class DashboardView extends LitElement {
            store = new StoreController(this, store);
            
            _viewTab(tab) {
                updateState({ activeTab: tab });
            }

            render() {
                const { stats, logs, apps } = this.store.value;
                const failingApp = apps.find(a => a.status === 'failed');

                return html`
                <div class="row">
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card stat-card text-white bg-primary h-100">
                            <div class="card-body">
                                <h5 class="card-title">Updates Available</h5>
                                <p class="card-text">${stats.updates}</p>
                                <a href="#" class="text-white stretched-link" @click=${() => this._viewTab('packages')}>View Packages</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card stat-card text-white bg-warning h-100">
                            <div class="card-body">
                                <h5 class="card-title">Unmanaged Packages</h5>
                                <p class="card-text">${stats.unmanaged}</p>
                                <a href="#" class="text-white stretched-link" @click=${() => this._viewTab('packages')}>Assign Now</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <h5 class="card-title text-muted">Total Packages</h5>
                                <p class="card-text">${stats.total}</p>
                                <a href="#" class="stretched-link" @click=${() => this._viewTab('packages')}>Manage</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3 mb-4">
                        <div class="card stat-card h-100">
                            <div class="card-body">
                                <h5 class="card-title text-muted">Connected Apps</h5>
                                <p class="card-text">${stats.apps}</p>
                                <a href="#" class="stretched-link" @click=${() => this._viewTab('apps')}>Configure</a>
                            </div>
                        </div>
                    </div>
                </div>
                ${failingApp ? html`
                <div class="card my-4">
                    <div class="card-body">
                        <h5 class="card-title d-flex justify-content-between align-items-center">
                            System Status
                            <a href="#" class="btn btn-sm btn-outline-secondary" @click=${() => this._viewTab('health')}>View Details <i class="bi bi-arrow-right"></i></a>
                        </h5>
                        <p class="card-text">
                            <span class="badge bg-danger me-2 fs-6">⚠️</span>
                            Connection to GitHub App "${failingApp.name}" is failing.
                        </p>
                    </div>
                </div>` : ''}
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Recent Activity</h5>
                        <div class="log-viewer">
                            ${logs.map(log => html`<div class="log-entry ${log.level}">${log.message}</div>`)}
                        </div>
                    </div>
                </div>`;
            }

            createRenderRoot() { return this; }
        }

        @customElement('packages-view')
        class PackagesView extends LitElement {
            store = new StoreController(this, store);
            
            render() {
                const { packages } = this.store.value;
                return html`
                 <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Package</th>
                                        <th>Installed Version</th>
                                        <th>Latest Version</th>
                                        <th>Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${packages.map(pkg => html`<package-row .pkg=${pkg}></package-row>`)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            }

            createRenderRoot() { return this; }
        }
        
        @customElement('package-row')
        class PackageRow extends LitElement {
            @property({ type: Object }) pkg;

            renderStatus() {
                switch(this.pkg.status) {
                    case 'update': return html`<span class="badge rounded-pill bg-warning">Update Available</span>`;
                    case 'ok': return html`<span class="badge rounded-pill bg-success">Up to date</span>`;
                    case 'unmanaged': return html`<span class="badge rounded-pill bg-secondary">Unmanaged</span>`;
                    default: return html``;
                }
            }
            
            renderActions() {
                if (this.pkg.status === 'unmanaged') {
                    return html`<button class="btn btn-primary btn-sm" @click=${() => updateState({ activeModal: 'assignApp', modalProps: { pkg: this.pkg } })}>Assign App</button>`;
                }

                return html`
                    <div class="btn-group">
                        ${this.pkg.status === 'update' ? html`
                            <button class="btn btn-primary btn-sm" @click=${() => updatePackage(this.pkg)} ?disabled=${this.pkg.isUpdating}>
                                ${this.pkg.isUpdating ? html`<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>` : html`Update to ${this.pkg.latest}`}
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots-vertical"></i></button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" @click=${() => updateState({ activeModal: 'rollback', modalProps: { pkg: this.pkg } })}>Rollback</a></li>
                        </ul>
                    </div>
                `;
            }

            render() {
                return html`
                    <tr>
                        <td><strong>${this.pkg.name}</strong><div class="text-muted small">${this.pkg.repo}</div></td>
                        <td>${this.pkg.version}</td>
                        <td>${this.pkg.latest}</td>
                        <td>${this.renderStatus()}</td>
                        <td class="text-end">${this.renderActions()}</td>
                    </tr>
                `;
            }
            createRenderRoot() { return this; }
        }

        @customElement('apps-view')
        class AppsView extends LitElement {
            store = new StoreController(this, store);
            render() {
                const { apps } = this.store.value;
                return html`
                 <div class="card">
                    <div class="card-body">
                        <h2 class="card-title">GitHub Apps</h2>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>App Name</th>
                                        <th>Account</th>
                                        <th>Managed Packages</th>
                                        <th>Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${apps.map(app => html`<app-row .app=${app}></app-row>`)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                `;
            }
            createRenderRoot() { return this; }
        }

        @customElement('app-row')
        class AppRow extends LitElement {
            @property({ type: Object }) app;

            render() {
                return html`
                    <tr>
                        <td><strong>${this.app.name}</strong></td>
                        <td>${this.app.account}</td>
                        <td>${this.app.packages}</td>
                        <td>
                            ${this.app.status === 'connected' 
                                ? html`<span class="badge rounded-pill bg-success">Connected</span>`
                                : html`<span class="badge rounded-pill bg-danger">Connection Failed</span>`
                            }
                        </td>
                        <td class="text-end">
                            <button class="btn btn-outline-secondary btn-sm">Settings</button>
                            <button class="btn btn-danger btn-sm" @click=${() => deleteApp(this.app)}>Delete</button>
                        </td>
                    </tr>
                `;
            }
            createRenderRoot() { return this; }
        }

        @customElement('health-view')
        class HealthView extends LitElement {
            store = new StoreController(this, store);
            
            renderCheck(check) {
                const badgeClass = check.status === 'success' ? 'bg-success' : 'bg-danger';
                const icon = check.status === 'success' ? '✔' : '✖';
                return html`
                <li class="list-group-item d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${check.check}</strong>
                        <p class="text-muted small mb-0">${check.message}</p>
                    </div>
                    <span class="badge ${badgeClass}">${icon}</span>
                </li>`;
            }

            render() {
                const { health } = this.store.value;
                if (!health.environment) return html`<p>Loading health status...</p>`;
                
                return html`
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">System Environment</h5>
                                <ul class="list-group list-group-flush">${health.environment.map(c => this.renderCheck(c))}</ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Application Integrity</h5>
                                <ul class="list-group list-group-flush">${health.integrity.map(c => this.renderCheck(c))}</ul>
                            </div>
                        </div>
                    </div>
                     <div class="col-lg-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Connectivity</h5>
                                <ul class="list-group list-group-flush">${health.connectivity.map(c => this.renderCheck(c))}</ul>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            createRenderRoot() { return this; }
        }

        // --- Modals & Managers ---
        @customElement('modal-manager')
        class ModalManager extends LitElement {
            store = new StoreController(this, store);
            modalInstance = null;
            
            updated() {
                const { activeModal } = this.store.value;
                const modalElement = this.querySelector('.modal');
                
                // If a modal is already active, hide and destroy it before showing a new one
                if (this.modalInstance) {
                    this.modalInstance.hide();
                    this.modalInstance.dispose();
                    this.modalInstance = null;
                }
                
                if (activeModal && modalElement) {
                    this.modalInstance = new bootstrap.Modal(modalElement);
                    this.modalInstance.show();

                    // Listen for the hide event to reset state
                    modalElement.addEventListener('hidden.bs.modal', () => {
                        updateState({ activeModal: null, modalProps: {} });
                    }, { once: true });
                }
            }

            render() {
                const { activeModal, modalProps } = this.store.value;
                switch (activeModal) {
                    case 'addApp': return html`<add-app-modal .props=${modalProps}></add-app-modal>`;
                    case 'rollback': return html`<rollback-modal .props=${modalProps}></rollback-modal>`;
                    case 'assignApp': return html`<assign-app-modal .props=${modalProps}></assign-app-modal>`;
                    case 'createPackage': return html`<create-package-modal .props=${modalProps}></create-package-modal>`;
                    default: return html``;
                }
            }
            createRenderRoot() { return this; }
        }

        @customElement('add-app-modal')
        class AddAppModal extends LitElement {
            render() {
                return html`
                <div class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add GitHub App</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Connect a new GitHub App to manage your private packages.</p>
                                <div class="d-grid gap-3">
                                     <button class="btn btn-primary btn-lg" type="button" data-bs-dismiss="modal">Create New App with Manifest</button>
                                     <button class="btn btn-secondary btn-lg" type="button" data-bs-dismiss="modal">Connect an Existing App Manually</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            createRenderRoot() { return this; }
        }

        @customElement('rollback-modal')
        class RollbackModal extends LitElement {
            @property({ type: Object }) props;
            
            _handleConfirm() {
                const select = this.querySelector('select');
                if (select.value) {
                    rollbackPackage(this.props.pkg, select.value);
                }
            }
            
            render() {
                const { pkg } = this.props;
                return html`
                <div class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Rollback ${pkg.name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Select a version to roll back to. The current version is ${pkg.version}.</p>
                                <select class="form-select">
                                    ${pkg.releases.map(r => html`<option value=${r}>${r}</option>`)}
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger" @click=${this._handleConfirm}>Confirm Rollback</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            createRenderRoot() { return this; }
        }
        
        @customElement('assign-app-modal')
        class AssignAppModal extends LitElement {
            @property({ type: Object }) props;
            store = new StoreController(this, store);

            _handleConfirm() {
                const select = this.querySelector('select');
                if (select.value) {
                    assignAppToPackage(this.props.pkg, select.value);
                }
            }

            render() {
                const { pkg } = this.props;
                const { apps } = this.store.value;
                return html`
                <div class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Assign App to ${pkg.name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Select a GitHub App to manage this package.</p>
                                <select class="form-select">
                                    ${apps.map(app => html`<option value=${app.id}>${app.name}</option>`)}
                                </select>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" @click=${this._handleConfirm}>Save Assignment</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            createRenderRoot() { return this; }
        }

        @customElement('create-package-modal')
        class CreatePackageModal extends LitElement {
            store = new StoreController(this, store);

            _handleConfirm(e) {
                e.preventDefault();
                const form = this.querySelector('form');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                if (form.checkValidity()) {
                    createPackage(data);
                } else {
                    form.classList.add('was-validated');
                }
            }

            render() {
                const { apps } = this.store.value;
                return html`
                <div class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <form class="needs-validation" novalidate @submit=${this._handleConfirm}>
                                <div class="modal-header">
                                    <h5 class="modal-title">Create New Package</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="repoName" class="form-label">Repository Name</label>
                                        <input type="text" class="form-control" name="repoName" placeholder="my-awesome-plugin" required>
                                        <div class="invalid-feedback">Please provide a repository name.</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="assignApp" class="form-label">Assign to App</label>
                                        <select name="assignApp" class="form-select" required>
                                            <option value="" selected disabled>Choose...</option>
                                            ${apps.map(app => html`<option value=${app.account.split(' ')[0]}>${app.name}</option>`)}
                                        </select>
                                        <div class="invalid-feedback">Please assign the package to an app.</div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-primary">Create Repository</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>`;
            }
            createRenderRoot() { return this; }
        }


        @customElement('notification-center')
        class NotificationCenter extends LitElement {
            store = new StoreController(this, store);

            render() {
                return html`
                <div class="toast-container position-fixed bottom-0 end-0 p-3">
                    ${this.store.value.notifications.map(note => html`
                        <notification-toast .note=${note}></notification-toast>
                    `)}
                </div>`;
            }

            createRenderRoot() { return this; }
        }

        @customElement('notification-toast')
        class NotificationToast extends LitElement {
            @property({ type: Object }) note;
            
            firstUpdated() {
                const toastEl = this.querySelector('.toast');
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
            }

            render() {
                const icon = {
                    success: 'bi-check-circle-fill text-success',
                    info: 'bi-info-circle-fill text-info',
                    danger: 'bi-x-circle-fill text-danger'
                }[this.note.type];

                return html`
                 <div class="toast align-items-center text-bg-${this.note.type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                           <i class="bi ${icon} me-2"></i> ${this.note.message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>`;
            }
            createRenderRoot() { return this; }
        }
        
        // =================================================================
        // 4. INITIALIZATION
        // =================================================================
        document.addEventListener('DOMContentLoaded', fetchInitialData);

    </script>
</body>
</html>

